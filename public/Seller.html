<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>LoopCart - Sustainable Marketplace for Sellers</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Sell your pre-loved items sustainably with AI-powered enhancements" />
  <style>
    :root {
      --primary: #10b981;
      --primary-dark: #059669;
      --primary-light: #d1fae5;
      --secondary: #3b82f6;
      --text: #1f2937;
      --text-light: #6b7280;
      --background: #f8fafc;
      --white: #ffffff;
      --border: #e5e7eb;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius: 12px;
      --radius-sm: 8px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      background: var(--background);
      color: var(--text);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    .header {
      text-align: center;
      margin-bottom: 32px;
      padding: 24px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .header-subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
      max-width: 600px;
      margin: 0 auto;
    }

    .eco-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--primary-light);
      color: var(--primary-dark);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 600;
      margin-top: 12px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
      margin-bottom: 32px;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--white);
      padding: 28px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--primary-light);
    }

    .card-header h3 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text);
    }

    .card-icon {
      width: 32px;
      height: 32px;
      background: var(--primary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text);
    }

    .input-group {
      margin-bottom: 20px;
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 1rem;
      transition: all 0.2s ease;
      background: var(--white);
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    input[type="file"] {
      width: 100%;
      padding: 12px;
      border: 2px dashed var(--border);
      border-radius: var(--radius-sm);
      background: var(--background);
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
    }

    .btn-secondary:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }

    .btn-outline {
      background: transparent;
      color: var(--text);
      border: 2px solid var(--border);
    }

    .btn-outline:hover {
      background: var(--background);
      border-color: var(--text-light);
    }

    .ai-box {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      padding: 20px;
      border-radius: var(--radius-sm);
      margin: 20px 0;
      border-left: 4px solid var(--secondary);
    }

    .ai-box strong {
      color: var(--secondary);
      font-size: 1.1rem;
    }

    .ai-features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .ai-feature {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: var(--radius-sm);
    }

    .ai-feature-icon {
      color: var(--primary);
      font-weight: bold;
    }

    .product-card {
      border: 1px solid var(--border);
      padding: 20px;
      border-radius: var(--radius);
      margin-bottom: 20px;
      display: flex;
      gap: 20px;
      background: var(--white);
      transition: all 0.2s ease;
    }

    .product-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .product-card img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: var(--radius-sm);
      flex-shrink: 0;
    }

    .product-info {
      flex: 1;
    }

    .product-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }

    .product-meta {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .product-tag {
      background: var(--primary-light);
      color: var(--primary-dark);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .product-description {
      color: var(--text-light);
      margin-bottom: 12px;
    }

    .product-price {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 12px;
    }

    .whatsapp-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #25D366;
      color: white;
      padding: 10px 20px;
      border-radius: var(--radius-sm);
      text-decoration: none;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .whatsapp-btn:hover {
      background: #128C7E;
      transform: translateY(-1px);
    }

    .sustainability-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin: 24px 0;
    }

    .metric {
      text-align: center;
      padding: 16px;
      background: var(--primary-light);
      border-radius: var(--radius);
    }

    .metric-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-dark);
    }

    .metric-label {
      font-size: 0.875rem;
      color: var(--text-light);
      margin-top: 4px;
    }

    .footer {
      text-align: center;
      padding: 24px;
      margin-top: 40px;
      border-top: 1px solid var(--border);
      color: var(--text-light);
      font-size: 0.875rem;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-light);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .success-message {
      background: var(--primary-light);
      color: var(--primary-dark);
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      margin: 16px 0;
      border-left: 4px solid var(--primary);
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <!-- Login status header -->
    <div style="text-align: right; margin-bottom: 20px;">
      <span id="userInfo">Checking login...</span>
      <a href="/login" id="loginLink" style="display:none; margin-left: 12px;">Login</a>
      <a href="/logout" id="logoutLink" style="display:none; margin-left: 12px;">Logout</a>
    </div>

    <div class="header">
      <h1><i class="fas fa-leaf"></i> LoopCart</h1>
      <p class="header-subtitle">Sustainable Marketplace ‚Äî Give your pre-loved items a new life with AI-powered enhancements</p>
      <div class="eco-badge">
        <i class="fas fa-recycle"></i>
        Promoting Circular Economy & Sustainable Consumption
      </div>
    </div>

    <div class="sustainability-metrics">
      <div class="metric">
        <div class="metric-value" id="carbonSaved">0 kg</div>
        <div class="metric-label">CO‚ÇÇ Saved</div>
      </div>
      <div class="metric">
        <div class="metric-value" id="itemsListed">0</div>
        <div class="metric-label">Items Listed</div>
      </div>
      <div class="metric">
        <div class="metric-value" id="wasteDiverted">0 kg</div>
        <div class="metric-label">Waste Diverted</div>
      </div>
      <div class="metric">
        <div class="metric-value" id="ecoScore">0%</div>
        <div class="metric-label">Avg Eco-Score</div>
      </div>
    </div>

    <div class="ai-box">
      <strong><i class="fas fa-robot"></i> AI-Powered Sustainability Tools</strong>
      <div class="ai-features">
        <div class="ai-feature">
          <span class="ai-feature-icon"><i class="fas fa-magic"></i></span>
          <span>Smart Description Generator</span>
        </div>
        <div class="ai-feature">
          <span class="ai-feature-icon"><i class="fas fa-tag"></i></span>
          <span>Fair Price Suggestion</span>
        </div>
        <div class="ai-feature">
          <span class="ai-feature-icon"><i class="fas fa-folder"></i></span>
          <span>Auto Category Detection</span>
        </div>
        <div class="ai-feature">
          <span class="ai-feature-icon"><i class="fas fa-leaf"></i></span>
          <span>Eco-Score Calculator</span>
        </div>
      </div>
    </div>

    <div class="grid">
      <div>
        <div class="card">
          <div class="card-header">
            <div class="card-icon">
              <i class="fas fa-plus"></i>
            </div>
            <h3>List New Product</h3>
          </div>

          <form id="addForm">
            <!-- REMOVED sellerName and sellerWhatsApp inputs -->

            <div class="input-group">
              <label for="title"><i class="fas fa-heading"></i> Product Title</label>
              <input type="text" id="title" placeholder="e.g., Wooden Study Table" />
            </div>

            <div class="input-group">
              <label for="quantity"><i class="fas fa-box"></i> Quantity</label>
              <input type="number" id="quantity" placeholder="e.g., 10" min="1" required />
            </div>

            <div class="input-group">
              <label for="pricePerUnit"><i class="fas fa-rupee-sign"></i> Price Per Unit</label>
              <input type="number" id="pricePerUnit" placeholder="e.g., 50" />
            </div>

            <div class="input-group">
              <label for="totalPrice"><i class="fas fa-calculator"></i> Total Price</label>
              <input type="number" id="totalPrice" readonly style="background-color: var(--background);" />
            </div>

            <div class="input-group">
              <label for="image"><i class="fas fa-image"></i> Product Images</label>
              <input type="file" id="image" accept="image/*" />
            </div>

            <div class="input-group">
              <label for="condition"><i class="fas fa-clipboard-check"></i> Condition</label>
              <select id="condition">
                <option>Used - Good</option>
                <option>Used - Like New</option>
                <option>Refurbished</option>
                <option>New</option>
              </select>
            </div>

            <div class="input-group">
              <label for="category"><i class="fas fa-tags"></i> Category</label>
              <input type="text" id="category" placeholder="Leave blank for auto-detection" />
            </div>

            <div class="input-group">
              <label for="description"><i class="fas fa-align-left"></i> Description</label>
              <textarea id="description" rows="4" placeholder="Let AI help generate an engaging description..."></textarea>
            </div>

            <div class="input-group">
              <label for="location"><i class="fas fa-map-marker-alt"></i> Location (address)</label>
              <input type="text" id="location" placeholder="e.g., MG Road, Bengaluru" />
            </div>

            <div class="button-group">
              <button type="button" id="btnEnhance" class="btn btn-primary">
                <i class="fas fa-wand-magic-sparkles"></i> AI Enhance
              </button>
              <div id="postButtons" style="display: flex; gap: 12px;">
                <button type="button" id="btnPostBuyers" class="btn btn-secondary">
                  <i class="fas fa-people-carry"></i> Post to Buyers
                </button>
                <button type="button" id="btnPostRecyclers" class="btn btn-outline" style="background:#fee2e2;color:#991b1b;border:1px solid #fca5a5;">
                  <i class="fas fa-recycle"></i> Post to Recyclers
                </button>
              </div>
              <button type="button" id="btnPost" class="btn btn-secondary" style="display:none;">
                <i class="fas fa-paper-plane"></i> Update Product
              </button>
            </div>

            <input type="hidden" id="productId" value="" />
            <div id="aiResults"></div>
          </form>
        </div>
      </div>

      <div>
        <div class="card">
          <div class="card-header">
            <div class="card-icon">
              <i class="fas fa-list"></i>
            </div>
            <h3>Your Listings</h3>
          </div>

          <div id="listings">
            <div class="empty-state">
              <div class="empty-state-icon">
                <i class="fas fa-box-open"></i>
              </div>
              <p>No listings yet</p>
              <p class="small">Add your first sustainable product to get started!</p>
            </div>
          </div>

          <div class="button-group">
            <button id="refreshBtn" class="btn btn-outline">
              <i class="fas fa-sync-alt"></i> Refresh Listings
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <p><strong>Sustainability Impact:</strong> Every pre-loved item sold reduces waste and carbon footprint. Thank you for contributing to a circular economy! ‚ôªÔ∏è</p>
      <p class="small" style="margin-top: 8px;">Images are stored securely. WhatsApp integration enables direct buyer-seller communication.</p>
    </div>
  </div>

<script>
// Global variable for current seller
let currentSeller = null;

// Check login state and get seller info
async function checkLogin() {
  try {
    const resp = await fetch('/api/me');
    const data = await resp.json();
    if (data.success && data.seller) {
      currentSeller = data.seller;
      document.getElementById('userInfo').textContent = `Logged in as ${currentSeller.name} (${currentSeller.username})`;
      document.getElementById('loginLink').style.display = 'none';
      document.getElementById('logoutLink').style.display = '';
      document.getElementById('addForm').style.display = '';
      loadListings();
    } else {
      redirectToLogin();
    }
  } catch (e) {
    redirectToLogin();
  }
}

function redirectToLogin() {
  document.getElementById('userInfo').textContent = 'Not logged in. Redirecting to login...';
  document.getElementById('loginLink').style.display = '';
  document.getElementById('logoutLink').style.display = 'none';
  document.getElementById('addForm').style.display = 'none';
  setTimeout(() => {
    window.location.href = '/login';
  }, 1500);
}

// Form data builder includes seller info from session, no inputs for seller name/WhatsApp
function buildProductFormData() {
  if (!currentSeller) {
    alert('You must be logged in to post a product.');
    return null;
  }
  const fd = new FormData();
  fd.append('sellerName', currentSeller.name);
  fd.append('sellerWhatsApp', currentSeller.whatsapp);

  fd.append('title', document.getElementById('title').value || 'Untitled item');
  fd.append('category', document.getElementById('category').value || 'Home');
  fd.append('description', document.getElementById('description').value || '');
  fd.append('condition', document.getElementById('condition').value);
  const quantity = parseInt(document.getElementById('quantity').value) || 0;
  const pricePerUnit = parseFloat(document.getElementById('pricePerUnit').value) || 0;
  fd.append('quantity', quantity.toString());
  fd.append('pricePerUnit', pricePerUnit.toString());
  fd.append('totalPrice', (quantity * pricePerUnit).toString());

  const locationVal = document.getElementById('location').value || '';
  if (locationVal) fd.append('location', locationVal);

  const imageFiles = document.getElementById('image').files;
  if (imageFiles.length) {
    for (let i = 0; i < imageFiles.length; i++) {
      fd.append('images', imageFiles[i]);
    }
  }

  const aiDiv = document.getElementById('aiResults');
  if (aiDiv.dataset.recommendedListing) fd.append('recommendedListing', aiDiv.dataset.recommendedListing);
  if (aiDiv.dataset.suggestedCategory) fd.append('suggestedCategory', aiDiv.dataset.suggestedCategory);
  if (aiDiv.dataset.rawAi) fd.append('raw_ai', aiDiv.dataset.rawAi);

  return fd;
}

async function runEnhance() {
  const title = document.getElementById('title').value;
  const category = document.getElementById('category').value;
  const condition = document.getElementById('condition').value;
  const image = document.getElementById('image').files[0];

  const fd = new FormData();
  fd.append('title', title);
  fd.append('condition', condition);
  fd.append('category', category);
  if (image) fd.append('image', image);

  const btn = document.getElementById('btnEnhance');
  btn.classList.add('loading');
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enhancing...';

  try {
    const res = await fetch('/api/ai/enhance', { method: 'POST', body: fd });
    const data = await res.json();
    if (data.success) {
      document.getElementById('description').value = data.description;
      document.getElementById('category').value = data.category;
      const aiDiv = document.getElementById('aiResults');
      const formattedOutput = data.description;

      if (data.price && (data.price.low || data.price.high)) {
        const low = data.price.low || data.price.high;
        const high = data.price.high || data.price.low;
        aiDiv.dataset.priceFrom = low;
        aiDiv.dataset.priceTo = high;
      }

      aiDiv.dataset.recommendedListing = (data.recommended_listing || data.recommendedListing || 'buyers');
      aiDiv.dataset.suggestedCategory = (data.suggested_category || data.suggestedCategory || data.category || '').toString();
      try { aiDiv.dataset.rawAi = JSON.stringify(data.raw_ai || {}); } catch (e) { aiDiv.dataset.rawAi = ''; }

      aiDiv.innerHTML = `<div class="success-message">
            <strong><i class="fas fa-check-circle"></i> AI Suggestions</strong>
            <div style="margin-top: 12px;">
              <div class="ai-suggestion-text" style="font-size: 1rem; line-height: 1.6; color: #374151; margin-bottom: 12px;">
                ${formattedOutput}
              </div>
              ${data.category ? `<div class="product-meta" style="margin-bottom: 8px;">
                <span class="product-tag">
                  <i class="fas fa-tag"></i> Category: ${data.category}
                </span>
                <span class="product-tag" style="background:${data.recommended_listing === 'recyclers' ? '#fee2e2' : '#eef2ff'}; color:${data.recommended_listing === 'recyclers' ? '#991b1b' : '#1e3a8a'};">
                  <i class="fas ${data.recommended_listing === 'buyers' ? 'fa-people-carry' : 'fa-recycle'}"></i>
                  Recommended: ${data.recommended_listing === 'buyers' ? 'Buyers' : 'Recyclers'}
                </span>
              </div>` : ''}
              ${data.imageUrl ? `<p><img src="${data.imageUrl}" style="max-width:120px;border-radius:6px;margin-top:8px;" />` : ''}
              <div style="margin-top: 12px; font-size: 0.875rem; color: #6b7280;">
                <i class="fas fa-info-circle"></i> You can post to either Buyers or Recyclers section below
              </div>
            </div>
          </div>`;
    } else {
      alert('AI enhance failed: ' + (data.message || 'Unknown error'));
    }
  } catch (error) {
    alert('Network error during AI enhancement');
  } finally {
    btn.classList.remove('loading');
    btn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> AI Enhance';
  }
}

async function postProductTo(target) {
  // target: 'buyers' | 'recyclers' | undefined

  const fd = buildProductFormData();
  if (!fd) return;

  const btn = target === 'buyers' ? document.getElementById('btnPostBuyers') :
    (target === 'recyclers' ? document.getElementById('btnPostRecyclers') :
      document.getElementById('btnPost'));

  const productId = document.getElementById('productId').value;
  const loadingText = productId ? 'Updating...' : 'Posting...';

  if (btn) {
    btn.classList.add('loading');
    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${loadingText}`;
  }

  try {
    let res;

    if (productId) {
      res = await fetch(`/api/products/${productId}`, {
        method: 'PUT',
        body: fd
      });

      if (res.status === 404) {
        if (target === 'buyers') res = await fetch('/api/products/buyers', { method: 'POST', body: fd });
        else if (target === 'recyclers') res = await fetch('/api/products/recyclers', { method: 'POST', body: fd });
        else res = await fetch('/api/products', { method: 'POST', body: fd });
      }
    } else {
      if (target === 'buyers') res = await fetch('/api/products/buyers', { method: 'POST', body: fd });
      else if (target === 'recyclers') res = await fetch('/api/products/recyclers', { method: 'POST', body: fd });
      else res = await fetch('/api/products', { method: 'POST', body: fd });
    }

    const data = await res.json();

    if (data.success) {
      const aiDiv = document.getElementById('aiResults');
      aiDiv.innerHTML = `<div class="success-message">
          <strong><i class="fas fa-check-circle"></i> Posted Successfully!</strong>
          <p>Your sustainable listing is now live. Thank you for reduProduct cing waste! üå±</p>
        </div>`;
      loadListings();
      document.getElementById('addForm').reset();
      document.getElementById('productId').value = '';
      aiDiv.dataset.priceFrom = '';
      aiDiv.dataset.priceTo = '';
      aiDiv.dataset.recommendedListing = '';
      aiDiv.dataset.suggestedCategory = '';
      aiDiv.dataset.rawAi = '';

      if (btn) btn.style.display = 'none';
      const btnPostBuyers = document.getElementById('btnPostBuyers');
      const btnPostRecyclers = document.getElementById('btnPostRecyclers');
      if (btnPostBuyers) btnPostBuyers.style.display = 'inline-flex';
      if (btnPostRecyclers) btnPostRecyclers.style.display = 'inline-flex';
    } else {
      alert('Failed to post product: ' + (data.error || data.message || 'Unknown error'));
    }
  } catch (error) {
    alert('Network error while posting product');
  } finally {
    if (btn) {
      btn.classList.remove('loading');
      if (!btn.hasAttribute('data-label')) btn.innerHTML = '<i class="fas fa-paper-plane"></i> Post Product';
    }
  }
}

function postProductBuyers() { return postProductTo('buyers'); }
function postProductRecyclers() { return postProductTo('recyclers'); }


async function loadListings() {
  const btn = document.getElementById('refreshBtn');
  btn.classList.add('loading');
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

  try {
    const res = await fetch('/api/my-products');
    const data = await res.json();
    const container = document.getElementById('listings');
    container.innerHTML = '';

    if (!data.success || !data.products.length) {
      container.innerHTML = `<div class="empty-state">
          <div class="empty-state-icon">
            <i class="fas fa-box-open"></i>
          </div>
          <p>No products listed yet</p>
          <p class="small">Create your first sustainable listing above!</p>
        </div>`;
      updateSustainabilityMetrics([]);
      return;
    }

    data.products.forEach(p => {
      const div = document.createElement('div');
      div.className = 'product-card';
      const img = document.createElement('img');
      img.src = p.images && p.images.length ? p.images[0] : '/placeholder.png';
      img.alt = p.title;
      const info = document.createElement('div');
      info.className = 'product-info';

      const quantity = parseInt(p.quantity) || 0;
      const pricePerUnit = parseFloat(p.pricePerUnit) || 0;
      const totalPrice = parseFloat(p.totalPrice) || (quantity * pricePerUnit);

      info.innerHTML = `
          <div class="product-title">${p.title}</div>
          <div class="product-meta">
            <span class="product-tag">${p.category || 'Uncategorized'}</span>
            <span class="product-tag">${p.condition}</span>
            ${p.recommendedListing ? `
              <span class="product-tag" style="background:${p.recommendedListing === 'recyclers' ? '#fee2e2' : '#eef2ff'};
                                              color:${p.recommendedListing === 'recyclers' ? '#991b1b' : '#1e3a8a'};
                                              font-weight:700;">
                <i class="fas ${p.recommendedListing === 'buyers' ? 'fa-people-carry' : 'fa-recycle'}"></i> 
                For ${p.recommendedListing === 'buyers' ? 'Buyers' : 'Recyclers'}
              </span>
            ` : ''}
          </div>
          <div class="product-description">${p.description || ''}</div>
          <div style="margin-top: 16px;">
            <div class="product-meta" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
              <span class="product-tag" style="background: #e0f2fe; color: #1e40af;">
                <i class="fas fa-box"></i> Quantity: ${quantity.toLocaleString()} units
              </span>
              <span class="product-tag" style="background: #f0fdf4; color: #166534;">
                <i class="fas fa-tag"></i> Price: ‚Çπ${pricePerUnit.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}/unit
              </span>
            </div>
            <div class="product-price" style="font-size: 1.25rem; font-weight: 600; color: #059669; background: #ecfdf5; padding: 8px 12px; border-radius: 8px;">
              <i class="fas fa-calculator"></i> Total: ‚Çπ${totalPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
            </div>
          </div>
          ${p.location && (p.location.address || (p.location.lat && p.location.lng)) ? (() => {
        const lat = p.location.lat; const lng = p.location.lng; const addr = p.location.address;
        const mapsUrl = (lat && lng) ? `https://www.google.com/maps/search/?api=1&query=${lat},${lng}` : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
        return `<a class="btn btn-outline" target="_blank" href="${mapsUrl}" style="margin-right:8px;"><i class="fas fa-map-marker-alt"></i> Open Location</a>`;
      })() : ''}
          <a class="whatsapp-btn" target="_blank" href="https://wa.me/${p.seller && p.seller.whatsapp ? p.seller.whatsapp : ''}?text=Hi!%20I%27m%20interested%20in%20your%20product%20${encodeURIComponent(p.title)}%20on%20LoopCart.">
            <i class="fab fa-whatsapp"></i> Contact Seller
          </a>
          <div style="margin-top:8px;display:flex;gap:8px;">
            <button class="btn btn-outline" onclick="editListing('${p._id}')"><i class="fas fa-edit"></i> Edit</button>
            <button class="btn btn-outline" onclick="deleteListing('${p._id}')" style="background:#fee2e2;color:#991b1b;border:1px solid #fca5a5;">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>`;

      div.appendChild(img);
      div.appendChild(info);
      container.appendChild(div);
    });

    if (!window.editListing) {
      window.editListing = async function (id) {
        try {
          const res = await fetch(`/api/products/${id}`);
          const data = await res.json();
          if (!data.success) return alert('Unable to fetch product');
          const p = data.product;

          document.getElementById('title').value = p.title || '';
          document.getElementById('category').value = p.category || '';
          document.getElementById('description').value = p.description || '';
          document.getElementById('condition').value = p.condition || 'Used - Good';
          document.getElementById('quantity').value = p.quantity || '';
          document.getElementById('pricePerUnit').value = p.pricePerUnit || '';
          document.getElementById('totalPrice').value = p.totalPrice || '';
          document.getElementById('location').value = p.location && p.location.address ? p.location.address : '';

          calculateTotalPrice();
          document.getElementById('productId').value = p._id;

          const btnPostBuyers = document.getElementById('btnPostBuyers');
          const btnPostRecyclers = document.getElementById('btnPostRecyclers');
          const btnPost = document.getElementById('btnPost');

          if (btnPostBuyers) btnPostBuyers.style.display = 'none';
          if (btnPostRecyclers) btnPostRecyclers.style.display = 'none';
          if (btnPost) {
            btnPost.style.display = 'inline-flex';
            btnPost.innerHTML = '<i class="fas fa-save"></i> Update Listing';
          }

          window.scrollTo({ top: 0, behavior: 'smooth' });
        } catch (err) {
          alert('Failed to load product for edit');
        }
      };
    }

    if (!window.deleteListing) {
      window.deleteListing = async function (id) {
        if (!confirm('Delete this product? This cannot be undone.')) return;
        try {
          const res = await fetch(`/api/products/${id}`, { method: 'DELETE' });
          const data = await res.json();
          if (data.success) {
            loadListings();
          } else {
            alert('Failed to delete: ' + (data.error || 'Unknown error'));
          }
        } catch (err) {
          alert('Error deleting product: ' + err.message);
        }
      };
    }

    updateSustainabilityMetrics(data.products);
  } catch (error) {
    alert('Successfully listed');
  } finally {
    btn.classList.remove('loading');
    btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Listings';
  }
}

// Calculate total price based on quantity and price per unit
function calculateTotalPrice() {
  const quantity = parseFloat(document.getElementById('quantity').value) || 0;
  const pricePerUnit = parseFloat(document.getElementById('pricePerUnit').value) || 0;
  const totalPrice = quantity * pricePerUnit;
  document.getElementById('totalPrice').value = totalPrice.toFixed(2);
}

document.addEventListener('DOMContentLoaded', function () {
  checkLogin();

  const btnEnhance = document.getElementById('btnEnhance');
  const btnPost = document.getElementById('btnPost');
  const btnPostBuyers = document.getElementById('btnPostBuyers');
  const btnPostRecyclers = document.getElementById('btnPostRecyclers');
  const btnRefresh = document.getElementById('refreshBtn');

  document.getElementById('quantity').addEventListener('input', calculateTotalPrice);
  document.getElementById('pricePerUnit').addEventListener('input', calculateTotalPrice);

  if (btnEnhance) btnEnhance.addEventListener('click', runEnhance);

  if (btnPost) btnPost.addEventListener('click', () => postProductTo());

  if (btnPostBuyers) {
    btnPostBuyers.setAttribute('data-label', '<i class="fas fa-people-carry"></i> Post to Buyers');
    btnPostBuyers.addEventListener('click', postProductBuyers);
  }
  if (btnPostRecyclers) {
    btnPostRecyclers.setAttribute('data-label', '<i class="fas fa-recycle"></i> Post to Recyclers');
    btnPostRecyclers.addEventListener('click', postProductRecyclers);
  }

  if (btnRefresh) btnRefresh.addEventListener('click', loadListings);
});
</script>

</body>
</html>
